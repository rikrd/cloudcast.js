<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>OpenHAB frontend</title>
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

    <script src="../../../lib/cloudcast.js"></script>
    <script src="../../../lib/recorder.js"></script>
    <script src="openhab.js"></script>
</head>
<body>

<div class="container">
    <div class="page-header">
        <h1>OpenHab voice controller <small>powered by CloudCast</small></h1>
    </div>

    <ol id="path" class="breadcrumb">
        <li class="active">Home</li>
    </ol>

    <div id="content">
    </div>

    <div id="current-actions-wrap" class="text-center">
        <div id="current-actions" class="btn-group-vertical">
        </div>
    </div>

    <pre id="log">
    </pre>


    <div id="accessing-sitemap-wait-dialog" class="modal fade" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Accessing the sitemap of the OpenHab server...</h4>
                </div>
                <div class="modal-body">
                    <div class="container-fluid">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
                                <span class="sr-only">100% Complete</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
var currentState = null;
var sitemap = null;
var currentChoices = [];
var availableWorkers = 0;

var content = $('#content');
var input = $('#input');
var status = $('#status');

var url = 'http://crossorigin.me/http://demo.openhab.org:9080/';

var openhab = new Openhab();

var cloudcast = new Cloudcast({
        recorderWorkerPath : '../../lib/recorderWorker.js',
        onInited : function() {
            cloudcast.open();
        },
        onReadyForSpeech : function() {
			__message("READY FOR SPEECH");
            $("#choose").prop("disabled", true);
		},
        onServerStatus : function(json) {
            availableWorkers = json.num_workers_available;
			if (availableWorkers != 0 && cloudcast.state < cloudcast.OPENED) {
                cloudcast.open();
			}
		},
        onOpened : function() {
            $('#choose').prop('disabled', false);
        },
        onClosed : function() {
            $('#choose').prop('disabled', true);
            if (availableWorkers != 0) {
                cloudcast.open();
			}
        },
        onResults : function(hypos) {
            var best_transcript = hypos[0].transcript;
            console.log(best_transcript);
            action();
        },
        onError : function(err, data) {
            console.log('Error: ' + err + ' ' + data);
            cloudcast.cancel();
        },
        onEvent : function(code, data) {
			__message(code, "CloudCast: " + data);
		}
});

function __message(code, data) {
	$("#log")[0].innerHTML = "msg: " + code + ": " + (data || '') + "\n" + $("#log")[0].innerHTML;
}

function action() {
    var request = $.ajax
    ({
        type       : "POST",
        url        : url + "rest/items/Light_FF_Office_Ceiling",
        data       : "ON",
        headers    : { "Content-Type": "text/plain" },
        crossDomain: true
    });

    request.done( function(data)
    {
        console.dir(data);
        sitemap = data;
        updateCurrentChoices();
    });

    request.fail( function(jqXHR, textStatus )
    {
        console.log( "Failure: " + textStatus );
    });

}

function getSitemap()
{
    var request = $.ajax
    ({
        type       : "GET",
        url        : url + "rest/sitemaps/demo",
        crossDomain: true,
    });

    request.done( function(data)
    {
        console.dir(data);
        sitemap = data;
        updateCurrentChoices();
    });

    request.fail( function(jqXHR, textStatus )
    {
        console.log( "Failure: " + textStatus );
    });
}

function updateCurrentChoices() {
    if (sitemap) {
        $("#current_choices").empty();
        currentChoices = [];
        $.each(sitemap.homepage.widget[0].widget, function(k, v) {
            $("#current_choices").append(v.label + '</br>');
            currentChoices.push(v.label);
        });
    }
}

function choose() {
        cloudcast.setTask({"task": {
                            "type": "forced-choice",
                            "params": {
                                "choices": currentChoices,
                                }
                            }
                        });

        cloudcast.startListening();
        window.setTimeout(cloudcast.stopListening, 2000);
}

function init_openhab() {
    $('#accessing-sitemap-wait-dialog').modal('show');

    openhab = new Openhab({
        onInited: inited_openhab,
        onNavigated: update_openhab,
        onEvent: function (code, data) {
            __message(code, "OpenHab: " + data);
        }
    });

    openhab.init();
}

function update_openhab() {
    update_current_actions();
    update_path();
}

function inited_openhab() {
    update_openhab();

    $('#accessing-sitemap-wait-dialog').modal('hide');
}

function update_path() {
    $('#path').empty();
    $('#path').append('<li><a href="#">Home</a></li>');

    var state = openhab.getState();
    console.dir(state);

    for (var i=0; i<state.length; i++) {
        var name = state[i].name;
        var markup;
        if (i<state.length-1) {
            markup = '<li><a href="#">' + name + '</a></li>';
        } else {
            markup = '<li class="active">' + name + '</li>';
        }
        $('#path').append(markup);
    }

    // TODO: handle the click events of the breadcrumb

}

function update_current_actions() {
    $('#current-actions').empty();

    var current_actions = openhab.getCurrentActions();
    console.dir(current_actions);

    for (var i=0; i<current_actions.length; i++) {
        var action = current_actions[i];
        var $markup = $('<button type="button" class="btn btn-default">'+ action.speech_command +'</button>');
        $markup.data('action', action);
        $markup.click(function(event) {
            console.dir($(this).data('action'));
            openhab.performAction($(this).data('action'));
        });
        $('#current-actions').append($markup);
    }

    // TODO: handle the click events of the buttons
}

window.onload = function() {
    init_openhab();
}
</script>
</body>
</html>
